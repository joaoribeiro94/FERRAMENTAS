import pandas as pd
import requests
import json
import time

# Configurações da API
URL = 'https://app.omie.com.br/api/v1/geral/produtos/'
APP_KEY = '3430208903121'
APP_SECRET = '94ed62fcadc1d3b12eccee7961a79165'

# Função para chamar a API e obter uma página específica de dados
def chamar_api_produtos(pagina):
    headers = {'Content-type': 'application/json'}
    data = {
        'call': 'ListarProdutos',
        'app_key': APP_KEY,
        'app_secret': APP_SECRET,
        'param': [
            {
                'pagina': pagina,
                'registros_por_pagina': 1000,
                'apenas_importado_api': 'N',
                'filtrar_apenas_omiepdv': 'N'
            }
        ]
    }

    response = requests.post(URL, headers=headers, json=data)
    if response.status_code == 200:
        return response.json()
    else:
        print(f'Erro na chamada da API (página {pagina}): {response.status_code}')
        return None

# Função para processar os dados de uma página
def processar_dados_produtos(api_data):
    """
    Estrutura esperada:
    {
      "pagina": 1,
      "total_de_paginas": 14,
      "registros": 1000,
      "total_de_registros": 13131,
      "produto_servico_cadastro": [ {...}, {...} ]
    }
    """
    rows = []
    columns = set()

    for item in api_data.get('produto_servico_cadastro', []):
        row = {}
        for key, value in item.items():
            if isinstance(value, dict):
                # Achata objetos como "info" e "recomendacoes_fiscais"
                for subkey, subvalue in value.items():
                    col_name = f"{key}_{subkey}"
                    row[col_name] = subvalue
                    columns.add(col_name)
            elif isinstance(value, list):
                # Se algum campo virar lista no futuro, salva como JSON
                row[key] = json.dumps(value, ensure_ascii=False)
                columns.add(key)
            else:
                row[key] = value
                columns.add(key)
        rows.append(row)

    df = pd.DataFrame(rows, columns=sorted(columns))
    return df

# Coleta de todas as páginas
pagina = 1
todos_dados = []

while True:
    print(f'Processando página {pagina} de produtos...')
    api_data = chamar_api_produtos(pagina)

    if not api_data or not api_data.get('produto_servico_cadastro'):
        # Sem dados ou erro
        break

    df_pagina = processar_dados_produtos(api_data)
    todos_dados.append(df_pagina)

    total_de_paginas = api_data.get('total_de_paginas')
    if not total_de_paginas or pagina >= total_de_paginas:
        # Já chegou na última página
        break

    pagina += 1
    time.sleep(0.5)  # respiro para não encher a API

# Juntar todos os dados e salvar
if todos_dados:
    df_final = pd.concat(todos_dados, ignore_index=True)
    df_final.to_excel('/content/sample_data/Produtos_Omie.xlsx', index=False)
    print('Dados de produtos salvos com sucesso no arquivo Produtos_Omie.xlsx!')
else:
    print('Nenhum dado de produtos encontrado ou erro ao consultar a API.')
